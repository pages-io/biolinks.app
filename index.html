<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioLink Studio - Cloud Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos CSS -->
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #F5F5F7; color: #1D1D1F; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #D1D1D6; border-radius: 20px; }
        .apple-input { transition: all 0.2s ease; border: 1px solid #E5E5EA; background-color: #FFFFFF; }
        .apple-input:focus { border-color: #007AFF; box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); outline: none; }
        select.apple-input { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; padding-right: 2.5rem; }
        .device-frame { box-shadow: 0 0 0 12px #383838, 0 0 0 14px #585858, 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); transition: opacity 0.3s ease; }
        .drag-handle { cursor: grab; } .drag-handle:active { cursor: grabbing; }
        .product-unavailable { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        .dropdown-menu { transform-origin: top right; transition: transform 0.1s ease-out, opacity 0.1s ease-out; }
        .icon-option { transition: all 0.2s; }
        .icon-option:hover { background-color: #F2F2F7; }
        .icon-option.selected { background-color: #EBF3FF; border: 2px solid #007AFF; color: #007AFF; }
        
        #loading-overlay { display: none; }
        #loading-overlay.active { display: flex; }
        
        /* Filter Modal Animation (Center Scale) */
        #filter-menu { transition: visibility 0s linear 0.2s, opacity 0.2s linear; opacity: 0; visibility: hidden; }
        #filter-menu.open { transition-delay: 0s; opacity: 1; visibility: visible; }
        #filter-menu-card { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); transform: translateY(-20px) scale(0.95); }
        #filter-menu.open #filter-menu-card { transform: scale(1) translateY(0); }
    </style>
</head>
<body class="h-screen overflow-hidden bg-[#F5F5F7]">

    <!-- PANTALLA DE CARGA -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-white flex items-center justify-center flex-col gap-4">
        <div class="w-10 h-10 border-4 border-blue-200 border-t-[#007AFF] rounded-full animate-spin"></div>
        <p class="text-sm font-medium text-gray-500 animate-pulse">Conectando con la nube...</p>
    </div>

    <!-- PANTALLA DE AUTENTICACIÓN -->
    <div id="auth-screen" class="w-full h-full flex items-center justify-center p-4 relative hidden">
        <div class="absolute inset-0 z-0">
             <div class="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
             <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
        </div>

        <div class="bg-white/80 backdrop-blur-xl w-full max-w-md p-8 rounded-3xl shadow-2xl border border-white z-10 fade-in">
            <div class="text-center mb-8">
                <div class="w-12 h-12 bg-black text-white rounded-xl flex items-center justify-center mx-auto mb-4 text-2xl shadow-lg">
                    <i class="ph-bold ph-link"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">BioLink Studio</h1>
                <p class="text-sm text-gray-500 mt-2">Crea tu página personal en minutos.</p>
            </div>

            <!-- Tabs Login/Register -->
            <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
                <button onclick="toggleAuthMode('login')" id="btn-tab-login" class="flex-1 py-2 text-sm font-medium rounded-lg bg-white shadow-sm text-gray-900 transition-all">Iniciar Sesión</button>
                <button onclick="toggleAuthMode('register')" id="btn-tab-register" class="flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900 transition-all">Registrarse</button>
            </div>

            <!-- Login Form -->
            <div id="login-form" class="space-y-4">
                <input type="email" id="login-email" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Correo electrónico">
                <input type="password" id="login-password" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Contraseña">
                <button onclick="handleLogin()" class="w-full bg-[#007AFF] hover:bg-[#0062cc] text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 transition-transform active:scale-95">
                    Entrar
                </button>
            </div>

            <!-- Register Form -->
            <div id="register-form" class="space-y-4 hidden">
                <div class="relative">
                    <input type="text" id="reg-username" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Nombre de usuario" oninput="checkUsername(this.value)">
                    <div id="username-status" class="absolute right-3 top-3.5 text-lg hidden"></div>
                </div>
                <p id="username-msg" class="text-xs text-red-500 hidden pl-1"></p>
                
                <input type="email" id="reg-email" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Correo electrónico">
                <input type="password" id="reg-password" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Contraseña">
                <button onclick="handleRegister()" id="btn-register-submit" class="w-full bg-[#007AFF] hover:bg-[#0062cc] text-white py-3 rounded-xl text-sm font-bold shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    Crear Cuenta
                </button>
            </div>

            <div class="my-6 flex items-center gap-3">
                <div class="h-px bg-gray-200 flex-1"></div>
                <span class="text-xs text-gray-400 font-medium">O CONTINUAR CON</span>
                <div class="h-px bg-gray-200 flex-1"></div>
            </div>

            <button onclick="handleGoogleLogin()" class="w-full bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 py-3 rounded-xl text-sm font-medium flex items-center justify-center gap-2 transition-colors">
                <i class="ph-bold ph-google-logo text-lg text-red-500"></i> Google
            </button>
        </div>
    </div>

    <!-- PANTALLA PRINCIPAL (APP) -->
    <div id="app-screen" class="h-full flex flex-col lg:flex-row hidden">
        <!-- LEFT PANEL -->
        <div id="left-panel" class="w-full h-full flex flex-col bg-white border-r border-gray-200 z-10 relative transition-all duration-300">
            <!-- Header -->
            <header class="h-16 flex items-center justify-between px-8 border-b border-gray-100 bg-white/80 backdrop-blur-md sticky top-0 z-20">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-black text-white rounded-lg flex items-center justify-center"><i class="ph-bold ph-link text-xl"></i></div>
                    <h1 class="font-semibold text-lg tracking-tight">BioLink Studio</h1>
                </div>
                
                <div class="flex items-center gap-3">
                    <!-- Editor Actions -->
                    <div id="editor-actions" class="flex gap-2 hidden">
                        <button onclick="saveCurrentPage()" class="p-2 text-gray-500 hover:text-[#007AFF] hover:bg-blue-50 rounded-lg transition-colors" title="Guardar"><i class="ph-bold ph-floppy-disk text-xl"></i></button>
                        <button onclick="publishPage()" class="bg-[#007AFF] hover:bg-[#0062cc] text-white px-4 py-1.5 rounded-full text-sm font-medium transition-colors shadow-md">Publicar</button>
                    </div>

                    <!-- User Menu -->
                    <div class="relative">
                        <button onclick="toggleUserMenu()" class="w-9 h-9 rounded-full overflow-hidden border-2 border-gray-200 hover:border-blue-500 transition-colors">
                            <img id="header-user-avatar" src="https://via.placeholder.com/100" class="w-full h-full object-cover">
                        </button>
                        <div id="user-menu" class="dropdown-menu hidden absolute right-0 top-12 w-56 bg-white rounded-xl shadow-xl border border-gray-100 z-50 overflow-hidden">
                            <div class="px-4 py-3 border-b border-gray-50">
                                <p id="menu-username" class="text-sm font-bold text-gray-900 truncate">Usuario</p>
                                <p id="menu-email" class="text-xs text-gray-500 truncate">user@email.com</p>
                            </div>
                            <button onclick="openUserSettingsModal('profile')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700"><i class="ph-bold ph-user"></i> Perfil</button>
                            <button onclick="openUserSettingsModal('settings')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex items-center gap-2 text-gray-700"><i class="ph-bold ph-gear"></i> Configuración</button>
                            <div class="h-px bg-gray-50 my-1"></div>
                            <button onclick="handleLogout()" class="w-full text-left px-4 py-2.5 text-sm hover:bg-red-50 text-red-600 flex items-center gap-2"><i class="ph-bold ph-sign-out"></i> Cerrar Sesión</button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tabs -->
            <div class="px-8 pt-6 pb-2">
                <div class="flex bg-[#F5F5F7] p-1 rounded-xl w-fit overflow-x-auto">
                    <button id="tab-dashboard" onclick="switchToDashboard()" class="px-6 py-1.5 rounded-lg text-sm font-medium bg-white shadow-sm text-black transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="ph-bold ph-squares-four"></i> Dashboard
                    </button>
                    <div id="editor-tabs" class="flex hidden">
                        <div class="w-px bg-gray-300 mx-1 h-6 self-center"></div>
                        <button id="tab-content" onclick="switchTab('content')" class="px-6 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:text-black transition-all">Contenido</button>
                        <button id="tab-design" onclick="switchTab('design')" class="px-6 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:text-black transition-all">Diseño</button>
                        <button id="tab-organize" onclick="switchTab('organize')" class="px-6 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:text-black transition-all">Organizar</button>
                        <button id="tab-shop" onclick="switchTab('shop')" class="px-6 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:text-black transition-all">Tienda</button>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto custom-scroll p-8 pb-32" id="editor-area">
                
                <!-- DASHBOARD -->
                <div id="section-dashboard" class="max-w-5xl mx-auto w-full">
                    <!-- Header Actions -->
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">Mis Páginas</h2>
                            <p class="text-sm text-gray-500 mt-1">Gestiona todos tus enlaces desde un solo lugar.</p>
                        </div>
                        <button onclick="createNewPage()" class="bg-black hover:bg-gray-800 text-white px-5 py-2.5 rounded-xl text-sm font-medium transition-colors shadow-lg shadow-black/10 flex items-center gap-2">
                            <i class="ph-bold ph-plus"></i> Crear Nueva
                        </button>
                    </div>

                    <!-- Active Pages -->
                    <div id="dashboard-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
                        <!-- Cards injected via JS -->
                    </div>

                    <!-- Archived Pages Section (Hidden by default) -->
                    <div id="archived-section" class="hidden">
                         <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 border-t border-gray-200 pt-6">Archivados</h3>
                         <div id="archived-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 opacity-75">
                            <!-- Archived cards injected here -->
                         </div>
                    </div>
                </div>

                <!-- SECTION: CONTENT (EDITOR) -->
                <div id="section-content" class="space-y-8 max-w-2xl hidden">
                    
                    <!-- Profile Section -->
                    <section>
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Perfil</h2>
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm space-y-5">
                            <div class="flex items-center gap-4">
                                <!-- Avatar Trigger -->
                                <div class="relative group cursor-pointer" onclick="openProfileModal()">
                                    <img id="input-avatar-preview" src="" class="w-20 h-20 rounded-full object-cover border-4 border-gray-50 shadow-sm transition-transform group-hover:scale-105">
                                    <div class="absolute inset-0 bg-black/30 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-[1px]">
                                        <i class="ph-bold ph-camera text-white text-2xl drop-shadow-md"></i>
                                    </div>
                                </div>
                                
                                <div class="flex-1 space-y-3">
                                    <input type="text" id="input-name" placeholder="Tu Nombre" class="apple-input w-full px-4 py-2.5 rounded-xl text-sm font-medium text-gray-900 placeholder-gray-400" oninput="updateState()">
                                    <input type="text" id="input-bio" placeholder="Tu Biografía" class="apple-input w-full px-4 py-2.5 rounded-xl text-sm text-gray-700 placeholder-gray-400" oninput="updateState()">
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 pl-1">Haz clic en la imagen para cambiarla.</p>
                        </div>
                    </section>

                    <!-- Social Icons Section -->
                    <section>
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Iconos Sociales <span id="social-count" class="text-xs font-normal opacity-50 ml-1">(0/4)</span></h2>
                            <button onclick="addSocial()" id="btn-add-social" class="flex items-center gap-1.5 text-[#007AFF] hover:text-[#005bb5] text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="ph-bold ph-plus"></i> Añadir
                            </button>
                        </div>

                        <div id="socials-container" class="space-y-3">
                            <!-- Social Icons injected here -->
                        </div>
                    </section>

                    <!-- Links Section -->
                    <section>
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Enlaces</h2>
                            <button onclick="addLink()" class="flex items-center gap-1.5 text-[#007AFF] hover:text-[#005bb5] text-sm font-medium transition-colors">
                                <i class="ph-bold ph-plus"></i> Añadir Enlace
                            </button>
                        </div>

                        <div id="links-container" class="space-y-3">
                            <!-- Links will be injected here via JS -->
                        </div>
                    </section>
                </div>

                <!-- SECTION: DESIGN -->
                <div id="section-design" class="space-y-8 max-w-2xl hidden">
                    <!-- Themes -->
                    <section>
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Temas</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Themes -->
                            <button onclick="setTheme('snow')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-white"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-gray-500">Snow</span>
                            </button>
                            <button onclick="setTheme('midnight')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-gray-900"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-gray-500">Midnight</span>
                            </button>
                            <button onclick="setTheme('blue')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-gradient-to-br from-blue-500 to-indigo-600"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-white">Ocean</span>
                            </button>
                            <button onclick="setTheme('sand')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-[#f3e9dc]"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-gray-500">Sand</span>
                            </button>
                            <button onclick="setTheme('forest')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-gradient-to-br from-emerald-800 to-teal-900"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-white/80">Forest</span>
                            </button>
                             <button onclick="setTheme('lavender')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-[#F3E8FF]"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-[#4A1D96]">Lavender</span>
                            </button>
                            <button onclick="setTheme('sunset')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-gradient-to-br from-orange-400 to-pink-500"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-white">Sunset</span>
                            </button>
                            <button onclick="setTheme('monochrome')" class="group relative aspect-[9/16] rounded-2xl border-2 border-transparent hover:border-[#007AFF] transition-all overflow-hidden text-left shadow-sm">
                                <div class="absolute inset-0 bg-gray-100 border-2 border-black m-2 rounded-xl"></div>
                                <span class="absolute bottom-3 left-0 right-0 text-center text-xs font-medium text-black">Noir</span>
                            </button>
                        </div>
                    </section>

                    <!-- Button Styles -->
                    <section>
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Estilo de Botones</h2>
                        <div id="button-styles-container" class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm grid grid-cols-3 gap-4">
                            <!-- Buttons injected via JS -->
                        </div>
                    </section>
                </div>

                <!-- SECTION: ORGANIZE -->
                <div id="section-organize" class="space-y-8 max-w-2xl hidden">
                    <section>
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">Organizar Bloques</h2>
                        <p class="text-sm text-gray-500 mb-4">Arrastra para cambiar el orden de las secciones en tu página.</p>
                        
                        <div id="sections-container" class="space-y-3">
                            <!-- Sections injected here -->
                        </div>
                    </section>
                </div>

                <!-- SECTION: SHOP -->
                <div id="section-shop" class="space-y-8 max-w-2xl hidden">
                    <section>
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Mis Productos</h2>
                            <div class="flex gap-2">
                                <button onclick="openCategoryManager()" class="flex items-center gap-1.5 text-gray-500 hover:text-black text-sm font-medium transition-colors bg-white border border-gray-200 px-3 py-1.5 rounded-lg hover:border-gray-300">
                                    <i class="ph-bold ph-list"></i> Categorías
                                </button>
                                <button onclick="addProduct()" class="flex items-center gap-1.5 text-white bg-[#007AFF] hover:bg-[#0062cc] px-3 py-1.5 rounded-lg text-sm font-medium transition-colors shadow-sm shadow-blue-500/20">
                                    <i class="ph-bold ph-plus"></i> Producto
                                </button>
                            </div>
                        </div>
                        
                        <!-- Products Editor Container -->
                        <div id="products-editor-container" class="space-y-3">
                            <!-- Products injected here -->
                        </div>
                    </section>
                </div>

            </div>
        </div>

        <!-- RIGHT PANEL: PREVIEW -->
        <div id="right-panel" class="hidden w-2/5 h-full bg-[#F5F5F7] items-center justify-center relative overflow-hidden border-l border-gray-200 transition-all duration-300">
            <!-- Blobs -->
            <div class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
            <div class="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-purple-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>

            <!-- Phone Frame -->
            <div id="preview-screen" class="relative w-[340px] h-[680px] bg-black rounded-[3rem] device-frame p-3 z-10 transition-transform duration-500 hover:scale-[1.01]">
                <div class="absolute top-0 left-1/2 transform -translate-x-1/2 h-7 w-32 bg-black rounded-b-2xl z-30"></div>
                <!-- Scrollable Container -->
                <div id="preview-scroll-container" class="w-full h-full bg-white rounded-[2.2rem] overflow-hidden overflow-y-auto relative no-scrollbar">
                    <div id="preview-bg" class="min-h-full w-full bg-white pt-16 pb-8 px-6 flex flex-col items-center transition-colors duration-500">
                        
                        <!-- VIEW: HOME -->
                        <div id="view-home" class="w-full flex flex-col items-center">
                            <!-- Sections Container -->
                            <div id="preview-sections-container" class="w-full flex flex-col items-center gap-6">
                                <!-- Dynamic Content Injected Here -->
                            </div>
                            <!-- Footer -->
                            <div class="mt-auto pt-10 pb-6">
                                <p class="text-[10px] uppercase tracking-widest font-bold opacity-30">Con tecnología de BioLink Studio</p>
                            </div>
                        </div>

                        <!-- VIEW: CATALOG -->
                        <div id="view-catalog" class="w-full hidden flex-col h-full relative">
                            <!-- Header -->
                            <div class="flex items-center justify-between mb-6 pt-2 w-full px-1">
                                <button onclick="setPreviewView('home')" class="p-2 rounded-full hover:bg-black/5 transition-colors">
                                    <i class="ph-bold ph-arrow-left text-xl"></i>
                                </button>
                                <h2 class="text-lg font-bold text-center">Catálogo</h2>
                                <button onclick="openFilterMenu()" class="p-2 rounded-full hover:bg-black/5 transition-colors">
                                    <i class="ph-bold ph-faders text-xl"></i>
                                </button>
                            </div>
                            
                            <!-- Current Filter Display -->
                            <div id="active-filter-display" class="w-full mb-4 hidden">
                                 <div class="inline-flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full text-xs font-medium text-gray-600">
                                    <span>Filtro: <span id="active-filter-name" class="text-black">Todo</span></span>
                                    <button onclick="selectFilter('all')" class="hover:text-red-500"><i class="ph-bold ph-x"></i></button>
                                 </div>
                            </div>

                            <!-- Full Product List -->
                            <div id="preview-products-catalog" class="space-y-4 pb-20 w-full overflow-y-auto no-scrollbar"></div>
                        </div>

                    </div>
                </div>

                <!-- Filter Overlay Menu (Fixed Position) -->
                <div id="filter-menu" class="absolute -top-3 -left-3 -right-3 -bottom-3 z-50 flex items-start justify-center pt-24 rounded-[3rem] overflow-hidden pointer-events-none hidden">
                    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm pointer-events-auto" onclick="closeFilterMenu()"></div>
                    <div id="filter-menu-card" class="relative bg-white w-full max-w-[280px] rounded-3xl shadow-2xl p-5 pointer-events-auto transform scale-95 transition-all duration-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Categorías</h3>
                            <button onclick="closeFilterMenu()" class="p-1.5 bg-gray-100 rounded-full hover:bg-gray-200 text-gray-500 transition-colors">
                                <i class="ph-bold ph-x"></i>
                            </button>
                        </div>
                        <div id="filter-options-container" class="space-y-2 max-h-[300px] overflow-y-auto custom-scroll">
                            <!-- Options injected here -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

    <!-- MODALS -->
    <!-- User Settings Modal -->
    <div id="user-settings-modal" class="fixed inset-0 z-[70] hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeUserSettingsModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl pointer-events-auto p-6 flex flex-col"><div class="flex justify-between mb-4"><h3 class="text-lg font-bold" id="settings-title">Configuración</h3><button onclick="closeUserSettingsModal()"><i class="ph-bold ph-x"></i></button></div><div id="settings-content" class="space-y-4"></div></div></div></div>
    
    <!-- Domain Modal -->
    <div id="domain-modal" class="fixed inset-0 z-[60] hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeDomainModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl pointer-events-auto p-6 flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">Configurar Dominio</h3><button onclick="closeDomainModal()"><i class="ph-bold ph-x text-lg"></i></button></div><p class="text-sm text-gray-500 mb-4">Personaliza la dirección web de tu página.</p><div class="flex items-center bg-gray-50 rounded-xl px-4 border border-gray-200 mb-6"><span class="text-gray-500 text-sm font-medium whitespace-nowrap">www.biolink.app/</span><input type="text" id="domain-input" class="bg-transparent border-none text-sm w-full py-3" placeholder="mi-pagina"></div><div class="flex justify-end gap-3"><button onclick="closeDomainModal()" class="px-5 py-2.5 rounded-xl text-sm bg-gray-100">Cancelar</button><button onclick="saveDomain()" class="px-5 py-2.5 rounded-xl text-sm text-white bg-[#007AFF]">Guardar</button></div></div></div></div>

    <!-- Rename Modal -->
    <div id="rename-modal" class="fixed inset-0 z-[60] hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeRenameModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl pointer-events-auto p-6 flex flex-col"><h3 class="text-lg font-bold mb-4">Renombrar Página</h3><input type="text" id="rename-input" class="apple-input w-full px-4 py-2.5 rounded-xl text-sm mb-6" placeholder="Nuevo nombre"><div class="flex justify-end gap-3"><button onclick="closeRenameModal()" class="px-4 py-2 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-100">Cancelar</button><button onclick="confirmRename()" class="px-4 py-2 rounded-xl text-sm font-medium text-white bg-[#007AFF] hover:bg-[#0062cc]">Guardar</button></div></div></div></div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="fixed inset-0 z-[60] hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeDeleteModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl transform transition-all scale-100 pointer-events-auto flex flex-col"><div class="p-6 text-center space-y-4"><div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-2"><i class="ph-bold ph-trash text-2xl"></i></div><h3 class="text-lg font-bold text-gray-900">¿Eliminar elemento?</h3><p class="text-sm text-gray-500">Esta acción no se puede deshacer.</p></div><div class="grid grid-cols-2 gap-3 p-6 pt-0"><button onclick="closeDeleteModal()" class="px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200">Cancelar</button><button onclick="confirmDeleteAction()" class="px-4 py-2.5 rounded-xl text-sm font-medium text-white bg-red-500 hover:bg-red-600">Eliminar</button></div></div></div></div>

    <!-- Edit Link Modal -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeEditModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl pointer-events-auto flex flex-col max-h-[90vh]"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between"><h3 class="text-lg font-semibold">Editar Enlace</h3><button onclick="closeEditModal()"><i class="ph-bold ph-x text-lg"></i></button></div><div class="p-6 overflow-y-auto custom-scroll space-y-6"><div><label class="block text-xs font-bold text-gray-400 uppercase mb-3">Icono</label><div id="modal-icon-grid" class="grid grid-cols-6 gap-2"></div></div><div class="space-y-4"><input type="text" id="modal-input-title" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Título"><input type="text" id="modal-input-url" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="URL" oninput="autoDetectIconInModal(this.value)"></div></div><div class="px-6 py-4 bg-gray-50 border-t border-gray-100 rounded-b-2xl flex justify-end gap-3"><button onclick="closeEditModal()" class="px-5 py-2.5 rounded-xl text-sm font-medium text-gray-600 hover:bg-gray-200">Cancelar</button><button onclick="saveEditLink()" class="px-6 py-2.5 rounded-xl text-sm font-medium text-white bg-[#007AFF]">Guardar</button></div></div></div></div>
    
    <!-- Edit Social Modal -->
    <div id="edit-social-modal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeEditSocialModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl pointer-events-auto flex flex-col max-h-[90vh]"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between"><h3 class="text-lg font-semibold">Icono Social</h3><button onclick="closeEditSocialModal()"><i class="ph-bold ph-x text-lg"></i></button></div><div class="p-6 overflow-y-auto custom-scroll space-y-6"><div><label class="block text-xs font-bold text-gray-400 uppercase mb-3">Icono</label><div id="social-modal-icon-grid" class="grid grid-cols-6 gap-2"></div></div><div class="space-y-4"><input type="text" id="social-modal-input-url" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="URL" oninput="autoDetectIconInSocialModal(this.value)"></div></div><div class="px-6 py-4 bg-gray-50 border-t border-gray-100 rounded-b-2xl flex justify-end gap-3"><button onclick="closeEditSocialModal()" class="px-5 py-2.5 rounded-xl text-sm text-gray-600 hover:bg-gray-200">Cancelar</button><button onclick="saveEditSocial()" class="px-6 py-2.5 rounded-xl text-sm text-white bg-[#007AFF]">Guardar</button></div></div></div></div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeProductModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl pointer-events-auto flex flex-col max-h-[90vh]"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between"><h3 class="text-lg font-semibold">Editar Producto</h3><button onclick="closeProductModal()"><i class="ph-bold ph-x text-lg"></i></button></div><div class="p-6 overflow-y-auto custom-scroll space-y-4"><div class="flex justify-center"><img id="modal-product-preview" src="" class="w-24 h-24 rounded-xl object-cover border shadow-sm"></div><input type="text" id="modal-product-img" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Imagen URL" oninput="document.getElementById('modal-product-preview').src = this.value"><input type="file" id="modal-product-file" class="hidden" onchange="handleProductFileSelect(this)"><label for="modal-product-file" class="block text-center text-sm text-[#007AFF] cursor-pointer font-medium hover:underline">Subir imagen</label><input type="text" id="modal-product-title" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Nombre"><div class="grid grid-cols-2 gap-4"><input type="text" id="modal-product-price" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Precio"><select id="modal-product-available" class="apple-input w-full px-4 py-3 rounded-xl text-sm"><option value="true">Disponible</option><option value="false">No disponible</option></select></div><div class="flex items-center justify-between bg-gray-50 p-3 rounded-xl border border-gray-200"><span class="text-sm font-medium text-gray-700">Mostrar Precio</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="modal-product-showPrice" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#007AFF]"></div></label></div><select id="modal-product-category" class="apple-input w-full px-4 py-3 rounded-xl text-sm"></select><input type="text" id="modal-product-url" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Enlace de Compra"></div><div class="px-6 py-4 bg-gray-50 border-t border-gray-100 rounded-b-2xl flex justify-end gap-3"><button onclick="closeProductModal()" class="px-5 py-2.5 rounded-xl text-sm text-gray-600 hover:bg-gray-200">Cancelar</button><button onclick="saveProduct()" class="px-6 py-2.5 rounded-xl text-sm text-white bg-[#007AFF]">Guardar</button></div></div></div></div>

    <!-- Category Modal -->
    <div id="category-modal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeCategoryManager()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl pointer-events-auto flex flex-col max-h-[80vh]"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between"><h3 class="text-lg font-semibold">Categorías</h3><button onclick="closeCategoryManager()"><i class="ph-bold ph-x text-lg"></i></button></div><div class="p-6 flex-1 overflow-y-auto custom-scroll"><div class="flex gap-2 mb-6"><input type="text" id="new-category-name" class="apple-input flex-1 px-4 py-2.5 rounded-xl text-sm" placeholder="Nueva Categoría"><button onclick="addCategory()" class="bg-[#007AFF] text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-[#0062cc]">Añadir</button></div><div id="category-list-container" class="space-y-3"></div></div><div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex justify-end"><button onclick="closeCategoryManager()" class="px-6 py-2.5 rounded-xl text-sm font-medium text-white bg-[#007AFF] w-full hover:bg-[#0062cc]">Listo</button></div></div></div></div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 modal-backdrop" onclick="closeProfileModal()"></div><div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none"><div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl pointer-events-auto flex flex-col"><div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between"><h3 class="text-lg font-semibold">Foto de Perfil</h3><button onclick="closeProfileModal()"><i class="ph-bold ph-x text-lg"></i></button></div><div class="p-6 space-y-6"><div class="flex justify-center"><img id="modal-profile-preview" src="" class="w-32 h-32 rounded-full object-cover border-4 shadow-md"></div><input type="text" id="modal-profile-url" class="apple-input w-full px-4 py-3 rounded-xl text-sm" placeholder="Enlace URL" oninput="updateProfilePreviewFromUrl(this.value)"><input type="file" id="modal-profile-file" class="hidden" onchange="handleProfileFileSelect(this)"><label for="modal-profile-file" class="flex items-center justify-center gap-2 w-full px-4 py-3 rounded-xl border border-dashed border-gray-300 hover:border-[#007AFF] text-gray-600 cursor-pointer"><i class="ph-bold ph-upload-simple text-xl"></i><span class="text-sm font-medium">Subir archivo</span></label></div><div class="px-6 py-4 bg-gray-50 border-t border-gray-100 rounded-b-2xl flex justify-end gap-3"><button onclick="closeProfileModal()" class="px-5 py-2.5 rounded-xl text-sm text-gray-600 hover:bg-gray-200">Cancelar</button><button onclick="saveProfileImage()" class="px-6 py-2.5 rounded-xl text-sm text-white bg-[#007AFF]">Guardar</button></div></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, updateEmail, deleteUser } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyCWI8mNdJIn-UO6tcNWyu182Kotq0ozRDU", authDomain: "biolinksapp-3fb04.firebaseapp.com", projectId: "biolinksapp-3fb04", storageBucket: "biolinksapp-3fb04.firebasestorage.app", messagingSenderId: "814839023327", appId: "1:814839023327:web:1aed3d7343bed87fa7cb6a", measurementId: "G-98TYVY92R2" };
        const appId = 'biolinks-app';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // GLOBAL STATE EXPORT
        window.currentUser = null;
        window.pages = [];
        window.appState = null;
        window.currentPageId = null;
        window.currentView = 'dashboard';
        
        // HELPERS EXPORT
        const ICON_MAP = [ { id: 'ph-link', label: 'Link' }, { id: 'ph-globe', label: 'Web' }, { id: 'ph-instagram-logo', label: 'IG', domains: ['instagram.com'] }, { id: 'ph-youtube-logo', label: 'YT', domains: ['youtube.com'] }, { id: 'ph-tiktok-logo', label: 'TikTok', domains: ['tiktok.com'] }, { id: 'ph-x-logo', label: 'X', domains: ['twitter.com'] }, { id: 'ph-facebook-logo', label: 'FB', domains: ['facebook.com'] }, { id: 'ph-linkedin-logo', label: 'In', domains: ['linkedin.com'] }, { id: 'ph-whatsapp-logo', label: 'WA', domains: ['whatsapp.com'] }, { id: 'ph-envelope', label: 'Mail', domains: ['mailto:'] }, { id: 'ph-storefront', label: 'Shop' } ];
        window.currentEditingId = null; window.currentEditingSocialId = null; window.currentEditingProductId = null; window.editingCategoryId = null; window.pendingDeleteAction = { type: null, id: null }; window.selectedIconInModal = 'ph-link'; window.selectedSocialIconInModal = 'ph-link'; window.tempAvatarUrl = ''; window.categoryFilter = 'all'; window.previewView = 'home'; window.renameTargetId = null; window.domainTargetId = null;

        // AUTH & INIT
        onAuthStateChanged(auth, async (user) => {
            window.currentUser = user;
            if (user) {
                const pRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info');
                onSnapshot(pRef, (snap) => {
                    if(snap.exists()) {
                        const d = snap.data();
                        document.getElementById('header-user-avatar').src = d.avatar || "https://via.placeholder.com/100";
                        document.getElementById('menu-username').textContent = d.username || "Usuario";
                    } else {
                        setDoc(pRef, { username: "Usuario", email: user.email, avatar: "https://via.placeholder.com/100" });
                    }
                    document.getElementById('menu-email').textContent = user.email;
                });
                
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('flex');
                
                const pagesRef = collection(db, 'artifacts', appId, 'users', user.uid, 'pages');
                onSnapshot(pagesRef, (snapshot) => {
                    window.pages = [];
                    snapshot.forEach(doc => window.pages.push({ id: doc.id, ...doc.data() }));
                    if (window.currentView === 'dashboard') window.renderDashboard();
                });
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('flex');
            }
            document.getElementById('loading-overlay').classList.remove('active');
        });

        // --- GLOBAL FUNCTIONS BINDING ---
        window.toggleAuthMode = (mode) => {
            const l=document.getElementById('login-form'), r=document.getElementById('register-form'), bl=document.getElementById('btn-tab-login'), br=document.getElementById('btn-tab-register');
            if(mode==='login'){ l.classList.remove('hidden'); r.classList.add('hidden'); bl.className="flex-1 py-2 text-sm font-medium rounded-lg bg-white shadow-sm text-gray-900"; br.className="flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900"; }
            else { l.classList.add('hidden'); r.classList.remove('hidden'); br.className="flex-1 py-2 text-sm font-medium rounded-lg bg-white shadow-sm text-gray-900"; bl.className="flex-1 py-2 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-900"; }
        };
        
        window.checkUsername = async (u) => {
            const s=document.getElementById('username-status'), m=document.getElementById('username-msg'), b=document.getElementById('btn-register-submit');
            if(u.length<3){ s.classList.add('hidden'); m.classList.add('hidden'); b.disabled=true; return; }
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'usernames', u));
            s.classList.remove('hidden');
            if(snap.exists()) { s.innerHTML='<i class="ph-bold ph-x-circle text-red-500"></i>'; m.textContent='No disponible'; m.classList.remove('hidden'); b.disabled=true; }
            else { s.innerHTML='<i class="ph-bold ph-check-circle text-green-500"></i>'; m.classList.add('hidden'); b.disabled=false; }
        };

        window.handleRegister = async () => {
            const e=document.getElementById('reg-email').value, p=document.getElementById('reg-password').value, u=document.getElementById('reg-username').value;
            try { document.getElementById('loading-overlay').classList.add('active'); const c=await createUserWithEmailAndPassword(auth, e, p); 
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'usernames', u), {uid:c.user.uid});
            await setDoc(doc(db, 'artifacts', appId, 'users', c.user.uid, 'profile', 'info'), {username:u, email:e, avatar:`https://ui-avatars.com/api/?name=${u}&background=random`});
            } catch(err){ alert(err.message); document.getElementById('loading-overlay').classList.remove('active'); }
        };

        window.handleLogin = async () => { try { document.getElementById('loading-overlay').classList.add('active'); await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); } catch(e) { alert(e.message); document.getElementById('loading-overlay').classList.remove('active'); } };
        window.handleGoogleLogin = async () => { try { document.getElementById('loading-overlay').classList.add('active'); await signInWithPopup(auth, googleProvider); } catch(e) { alert(e.message); document.getElementById('loading-overlay').classList.remove('active'); } };
        window.handleLogout = async () => { await signOut(auth); window.location.reload(); };

        window.toggleUserMenu = () => document.getElementById('user-menu').classList.toggle('hidden');
        window.openUserSettingsModal = (type) => {
            const m = document.getElementById('user-settings-modal');
            const t = document.getElementById('settings-title');
            const c = document.getElementById('settings-content');
            document.getElementById('user-menu').classList.add('hidden');
            m.classList.remove('hidden');
            
            if(type === 'profile') {
                t.textContent = 'Editar Perfil';
                c.innerHTML = `<div class="space-y-3">
                        <div class="flex justify-center mb-4"><img id="setting-avatar-preview" src="${document.getElementById('header-user-avatar').src}" class="w-24 h-24 rounded-full object-cover border-4 shadow-sm"></div>
                        <input type="text" id="setting-avatar" class="apple-input w-full px-3 py-2 rounded-lg text-sm" placeholder="URL de imagen" oninput="document.getElementById('setting-avatar-preview').src = this.value" value="${document.getElementById('header-user-avatar').src}">
                        <div class="relative"><input type="file" id="setting-file" class="hidden" onchange="handleUserAvatarFileSelect(this)"><label for="setting-file" class="block text-center text-sm text-[#007AFF] cursor-pointer font-medium hover:underline">Subir desde dispositivo</label></div>
                    </div><button onclick="saveUserProfileSettings()" class="w-full bg-[#007AFF] text-white py-2 rounded-lg text-sm mt-4">Guardar</button>`;
            } else {
                t.textContent = 'Configuración';
                c.innerHTML = `<div class="space-y-4"><button onclick="alert('Función próximamente')" class="w-full text-left px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-sm font-medium flex justify-between items-center">Cambiar Correo <i class="ph-bold ph-envelope-simple"></i></button><button onclick="if(confirm('¿Borrar cuenta?')) alert('Contacta soporte')" class="w-full text-left px-4 py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl text-sm font-medium flex justify-between items-center">Eliminar Cuenta <i class="ph-bold ph-trash"></i></button></div>`;
            }
        };
        window.handleUserAvatarFileSelect = (input) => { if(input.files[0]) { const r=new FileReader(); r.onload=e=>{document.getElementById('setting-avatar-preview').src=e.target.result; document.getElementById('setting-avatar').value=e.target.result;}; r.readAsDataURL(input.files[0]); } };
        window.closeUserSettingsModal = () => document.getElementById('user-settings-modal').classList.add('hidden');
        window.saveUserProfileSettings = async () => {
             const av = document.getElementById('setting-avatar').value;
             await setDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'profile', 'info'), { avatar: av }, { merge: true });
             window.closeUserSettingsModal();
        };

        window.createNewPage = async () => {
            if(!window.currentUser) return;
            const newId = crypto.randomUUID();
            const newPage = { name: 'Nueva Página', slug: 'pagina-'+Date.now(), active: true, archived: false, data: { profile: { name: "Usuario", bio: "Hola", avatar: `https://ui-avatars.com/api/?name=Usuario&background=random` }, design: { theme: 'snow', buttonStyle: 'rounded-xl' }, sections: [{id:'profile', label:'Perfil', enabled:true}, {id:'socials', label:'Social', enabled:true}, {id:'links', label:'Enlaces', enabled:true}, {id:'products', label:'Tienda', enabled:true}], links: [], socials: [], categories: [], products: [] } };
            await setDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'pages', newId), newPage);
            window.editPage(newId);
        };

        window.editPage = (id) => {
            const page = window.pages.find(p => p.id === id); if(!page) return;
            window.currentPageId = id; window.appState = JSON.parse(JSON.stringify(page.data)); window.currentView = 'editor';
            document.getElementById('section-dashboard').classList.add('hidden'); document.getElementById('left-panel').classList.remove('w-full'); document.getElementById('left-panel').classList.add('lg:w-3/5'); document.getElementById('right-panel').classList.remove('hidden'); document.getElementById('right-panel').classList.add('lg:flex'); document.getElementById('editor-tabs').classList.remove('hidden'); document.getElementById('editor-actions').classList.remove('hidden'); document.getElementById('tab-dashboard').classList.remove('bg-white', 'shadow-sm', 'text-black'); document.getElementById('tab-dashboard').classList.add('text-gray-500');
            window.switchTab('content'); window.updateEditorFields(); window.renderEditorLinks(); window.renderEditorSocials(); window.renderEditorProducts(); window.renderSectionsEditor();
            window.updateButtonStyleButtons(window.appState.design.buttonStyle.includes('none') ? 'sharp' : (window.appState.design.buttonStyle.includes('full') ? 'pill' : 'rounded')); window.renderPreview();
        };

        window.saveCurrentPage = async () => {
            if(!window.currentUser || !window.currentPageId) return;
            const btn = document.querySelector('button[title="Guardar"] i'); if(btn) btn.className="ph-bold ph-spinner animate-spin";
            await updateDoc(doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'pages', window.currentPageId), { data: window.appState });
            if(btn) { btn.className="ph-bold ph-check text-green-500"; setTimeout(()=>btn.className="ph-bold ph-floppy-disk text-xl", 1000); }
        };

        window.renderDashboard = () => {
            const c = document.getElementById('dashboard-cards-container'); const ac = document.getElementById('archived-cards-container'); c.innerHTML=''; ac.innerHTML=''; let hasArc = false;
            window.pages.forEach(p => {
                const html = `<div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow relative group"><div class="flex justify-between items-start mb-4"><div class="w-12 h-12 rounded-xl bg-gray-50 flex items-center justify-center text-gray-400"><i class="ph-bold ph-browser text-2xl"></i></div><div class="relative"><button onclick="toggleCardMenu('${p.id}')" class="p-2 hover:bg-gray-100 rounded-full"><i class="ph-bold ph-dots-three-vertical text-xl"></i></button><div id="menu-${p.id}" class="dropdown-menu hidden absolute right-0 top-10 w-48 bg-white rounded-xl shadow-xl border border-gray-100 z-10 overflow-hidden"><button onclick="openRenamePage('${p.id}')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex gap-2"><i class="ph-bold ph-pencil-simple"></i> Renombrar</button><button onclick="openDomainModal('${p.id}')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex gap-2"><i class="ph-bold ph-globe"></i> Dominio</button>${!p.archived?`<button onclick="togglePageStatus('${p.id}')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex gap-2"><i class="ph-bold ${p.active?'ph-toggle-right':'ph-toggle-left'}"></i> ${p.active?'Desactivar':'Activar'}</button>`:''} <button onclick="${p.archived?'unarchivePage':'archivePage'}('${p.id}')" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-50 flex gap-2"><i class="ph-bold ${p.archived?'ph-arrow-u-up-left':'ph-archive'}"></i> ${p.archived?'Desarchivar':'Archivar'}</button></div></div></div><h3 class="text-lg font-bold text-gray-900 mb-1 truncate">${p.name}</h3><p class="text-xs text-gray-400 mb-3 truncate">biolink.app/${p.slug||''}</p><div class="flex items-center gap-2 text-xs text-gray-500 mb-6"><span class="w-2 h-2 rounded-full ${p.active?'bg-green-500':'bg-gray-300'}"></span>${p.active?'Activo':'Inactivo'}</div><div class="flex gap-2 mt-auto"><button onclick="editPage('${p.id}')" class="flex-1 bg-black text-white py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2"><i class="ph-bold ph-pencil-simple"></i> Editar</button><button onclick="openDeleteModal('page', '${p.id}')" class="p-2 border rounded-lg hover:text-red-500"><i class="ph-bold ph-trash text-lg"></i></button></div></div>`;
                if(p.archived) { hasArc=true; ac.innerHTML+=html; } else { c.innerHTML+=html; }
            });
            document.getElementById('archived-section').classList.toggle('hidden', !hasArc);
        };

        window.toggleCardMenu = (id) => { const m=document.getElementById(`menu-${id}`); document.querySelectorAll('.dropdown-menu').forEach(d=>d!==m && d.classList.add('hidden')); m.classList.toggle('hidden'); };
        window.switchTab = (tab) => {
            if(tab==='dashboard') return window.switchToDashboard();
            ['content','design','organize','shop'].forEach(t => { document.getElementById(`section-${t}`).classList.add('hidden'); document.getElementById(`tab-${t}`).className="px-6 py-1.5 rounded-lg text-sm font-medium text-gray-500 hover:text-black transition-all"; });
            document.getElementById(`section-${tab}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).className="px-6 py-1.5 rounded-lg text-sm font-medium bg-white shadow-sm text-black transition-all";
        };
        window.switchToDashboard = () => {
            window.currentView = 'dashboard';
            document.getElementById('section-dashboard').classList.remove('hidden');
            ['content', 'design', 'organize', 'shop'].forEach(s => document.getElementById(`section-${s}`).classList.add('hidden'));
            document.getElementById('left-panel').classList.remove('lg:w-3/5'); document.getElementById('left-panel').classList.add('w-full');
            document.getElementById('right-panel').classList.add('hidden'); document.getElementById('right-panel').classList.remove('lg:flex');
            document.getElementById('editor-tabs').classList.add('hidden'); document.getElementById('editor-actions').classList.add('hidden');
            document.getElementById('tab-dashboard').classList.add('bg-white', 'shadow-sm', 'text-black'); document.getElementById('tab-dashboard').classList.remove('text-gray-500');
            window.renderDashboard();
        };

        // Modals & CRUD
        window.openRenamePage = (id) => { window.renameTargetId=id; document.getElementById('rename-input').value=window.pages.find(p=>p.id===id).name; document.getElementById('rename-modal').classList.remove('hidden'); window.toggleCardMenu(id); };
        window.closeRenameModal = () => document.getElementById('rename-modal').classList.add('hidden');
        window.confirmRename = async () => { const n=document.getElementById('rename-input').value; if(n && window.renameTargetId) { await updateDoc(doc(db,'artifacts',appId,'users',window.currentUser.uid,'pages',window.renameTargetId), {name:n}); window.closeRenameModal(); } };
        window.openDomainModal = (id) => { window.domainTargetId=id; document.getElementById('domain-input').value=window.pages.find(p=>p.id===id).slug||''; document.getElementById('domain-modal').classList.remove('hidden'); window.toggleCardMenu(id); };
        window.closeDomainModal = () => document.getElementById('domain-modal').classList.add('hidden');
        window.saveDomain = async () => { const s=document.getElementById('domain-input').value; if(window.domainTargetId) { await updateDoc(doc(db,'artifacts',appId,'users',window.currentUser.uid,'pages',window.domainTargetId), {slug:s}); window.closeDomainModal(); } };
        window.togglePageStatus = async (id) => { const p=window.pages.find(x=>x.id===id); await updateDoc(doc(db,'artifacts',appId,'users',window.currentUser.uid,'pages',id), {active:!p.active}); };
        window.archivePage = async (id) => { await updateDoc(doc(db,'artifacts',appId,'users',window.currentUser.uid,'pages',id), {archived:true}); };
        window.unarchivePage = async (id) => { await updateDoc(doc(db,'artifacts',appId,'users',window.currentUser.uid,'pages',id), {archived:false}); };
        
        // Editor CRUD
        window.updateEditorFields = () => { document.getElementById('input-name').value=window.appState.profile.name; document.getElementById('input-bio').value=window.appState.profile.bio; document.getElementById('input-avatar-preview').src=window.appState.profile.avatar; };
        window.updateState = () => { window.appState.profile.name=document.getElementById('input-name').value; window.appState.profile.bio=document.getElementById('input-bio').value; window.renderPreview(); };
        window.openProfileModal = () => { if(!window.appState) return; window.tempAvatarUrl=window.appState.profile.avatar; document.getElementById('modal-profile-preview').src=window.tempAvatarUrl; document.getElementById('modal-profile-url').value=''; document.getElementById('profile-modal').classList.remove('hidden'); };
        window.closeProfileModal = () => document.getElementById('profile-modal').classList.add('hidden');
        window.updateProfilePreviewFromUrl = (url) => { if(url) document.getElementById('modal-profile-preview').src=url; };
        window.handleProfileFileSelect = (i) => { if(i.files[0]) { const r=new FileReader(); r.onload=e=>document.getElementById('modal-profile-preview').src=e.target.result; r.readAsDataURL(i.files[0]); } };
        window.saveProfileImage = () => { window.appState.profile.avatar=document.getElementById('modal-profile-preview').src; window.updateEditorFields(); window.renderPreview(); window.closeProfileModal(); };
        
        window.renderEditorLinks = () => { const c=document.getElementById('links-container'); c.innerHTML=''; window.appState.links.forEach(l=>{c.innerHTML+=`<div class="bg-white p-3 rounded-xl border flex items-center gap-2"><i class="ph-bold ph-dots-six-vertical text-gray-400 drag-handle"></i><div class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center"><i class="ph-bold ${l.icon}"></i></div><span class="flex-1 text-sm font-medium">${l.title}</span><button onclick="openEditModal(${l.id})" class="p-2 hover:bg-gray-100 rounded"><i class="ph-bold ph-pencil-simple text-lg"></i></button><button onclick="openDeleteModal('link', ${l.id})" class="p-2 hover:text-red-500 rounded"><i class="ph-bold ph-trash text-lg"></i></button></div>`;}); };
        window.addLink = () => { window.appState.links.push({id:Date.now(), title:'Link', url:'', icon:'ph-link'}); window.renderEditorLinks(); window.renderPreview(); window.openEditModal(window.appState.links[window.appState.links.length-1].id); };
        window.openEditModal = (id) => { const l=window.appState.links.find(x=>x.id===id); if(l) { window.currentEditingId=id; window.selectedIconInModal=l.icon; document.getElementById('modal-input-title').value=l.title; document.getElementById('modal-input-url').value=l.url; window.renderIconGrid(); document.getElementById('edit-modal').classList.remove('hidden'); } };
        window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');
        window.saveEditLink = () => { const l=window.appState.links.find(x=>x.id===window.currentEditingId); if(l) { l.title=document.getElementById('modal-input-title').value; l.url=document.getElementById('modal-input-url').value; l.icon=window.selectedIconInModal; } window.renderEditorLinks(); window.renderPreview(); window.closeEditModal(); };
        window.renderIconGrid = () => { const g=document.getElementById('modal-icon-grid'); g.innerHTML=''; ICON_MAP.forEach(i => g.innerHTML+=`<button onclick="selectedIconInModal='${i.id}';renderIconGrid()" class="icon-option aspect-square rounded-xl flex items-center justify-center text-xl text-gray-600 ${window.selectedIconInModal===i.id?'selected':'bg-gray-50 border border-transparent'}"><i class="ph-bold ${i.id}"></i></button>`); };
        window.autoDetectIconInModal = (url) => { const i=window.getIconForUrl(url); if(i!=='ph-link') { window.selectedIconInModal=i; window.renderIconGrid(); } };

        window.renderEditorSocials = () => { const c=document.getElementById('socials-container'); c.innerHTML=''; document.getElementById('social-count').textContent=`(${window.appState.socials.length}/4)`; window.appState.socials.forEach(s=>{c.innerHTML+=`<div class="bg-white p-3 rounded-xl border flex items-center gap-2"><i class="ph-bold ${s.icon} text-lg"></i><span class="flex-1 text-xs truncate text-gray-400">${s.url}</span><button onclick="openEditSocialModal(${s.id})" class="p-2 hover:bg-gray-100 rounded"><i class="ph-bold ph-pencil-simple text-lg"></i></button><button onclick="openDeleteModal('social', ${s.id})" class="p-2 hover:text-red-500 rounded"><i class="ph-bold ph-trash text-lg"></i></button></div>`;}); };
        window.addSocial = () => { if(window.appState.socials.length<4) { const id=Date.now(); window.appState.socials.push({id, url:'', icon:'ph-link'}); window.renderEditorSocials(); window.renderPreview(); window.openEditSocialModal(id); } };
        window.openEditSocialModal = (id) => { const s=window.appState.socials.find(x=>x.id===id); if(s) { window.currentEditingSocialId=id; window.selectedSocialIconInModal=s.icon; document.getElementById('social-modal-input-url').value=s.url; window.renderSocialIconGrid(); document.getElementById('edit-social-modal').classList.remove('hidden'); } };
        window.closeEditSocialModal = () => document.getElementById('edit-social-modal').classList.add('hidden');
        window.saveEditSocial = () => { const s=window.appState.socials.find(x=>x.id===window.currentEditingSocialId); if(s) { s.url=document.getElementById('social-modal-input-url').value; s.icon=window.selectedSocialIconInModal; } window.renderEditorSocials(); window.renderPreview(); window.closeEditSocialModal(); };
        window.renderSocialIconGrid = () => { const g=document.getElementById('social-modal-icon-grid'); g.innerHTML=''; ICON_MAP.forEach(i => g.innerHTML+=`<button onclick="selectedSocialIconInModal='${i.id}';renderSocialIconGrid()" class="icon-option aspect-square rounded-xl flex items-center justify-center text-xl text-gray-600 ${window.selectedSocialIconInModal===i.id?'selected':'bg-gray-50 border border-transparent'}"><i class="ph-bold ${i.id}"></i></button>`); };
        window.autoDetectIconInSocialModal = (url) => { const i=window.getIconForUrl(url); if(i!=='ph-link') { window.selectedSocialIconInModal=i; window.renderSocialIconGrid(); } };

        window.renderEditorProducts = () => { const c=document.getElementById('products-editor-container'); c.innerHTML=''; window.appState.products.forEach(p=>{const op=p.visible?'':'opacity-50'; c.innerHTML+=`<div class="bg-white p-3 rounded-xl border flex items-center gap-2 ${op}"><i class="ph-bold ph-dots-six-vertical text-gray-400 drag-handle"></i><img src="${p.img}" class="w-8 h-8 rounded object-cover"><span class="flex-1 text-sm font-medium">${p.title}</span><button onclick="toggleProductVisibility(${p.id})" class="p-2"><i class="ph-bold ${p.visible?'ph-eye':'ph-eye-slash'}"></i></button><button onclick="openProductModal(${p.id})" class="p-2"><i class="ph-bold ph-pencil-simple"></i></button><button onclick="openDeleteModal('product', ${p.id})" class="p-2 hover:text-red-500"><i class="ph-bold ph-trash text-lg"></i></button></div>`;}); };
        window.addProduct = () => { const id=Date.now(); window.appState.products.push({id, title:'Producto', price:'$0', url:'', img:`https://ui-avatars.com/api/?name=Producto&background=random`, categoryId:null, available:true, visible:true, showPrice:true}); window.renderEditorProducts(); window.renderPreview(); window.openProductModal(id); };
        window.openProductModal = (id) => { 
            const p=window.appState.products.find(x=>x.id===id); if(!p) return; window.currentEditingProductId=id; 
            document.getElementById('modal-product-title').value=p.title; document.getElementById('modal-product-price').value=p.price; document.getElementById('modal-product-url').value=p.url; document.getElementById('modal-product-img').value=''; document.getElementById('modal-product-preview').src=p.img; document.getElementById('modal-product-available').value=p.available.toString(); document.getElementById('modal-product-showPrice').checked=p.showPrice!==false;
            const sel=document.getElementById('modal-product-category'); sel.innerHTML='<option value="">Sin Categoría</option>'; window.appState.categories.forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.text=c.name; if(p.categoryId===c.id)o.selected=true; sel.appendChild(o);});
            document.getElementById('edit-product-modal').classList.remove('hidden'); 
        };
        window.closeProductModal = () => document.getElementById('edit-product-modal').classList.add('hidden');
        window.saveProduct = () => { 
            if(!window.currentEditingProductId) return; const p = window.appState.products.find(x => x.id === window.currentEditingProductId);
            if(p) { p.title=document.getElementById('modal-product-title').value; p.price=document.getElementById('modal-product-price').value; p.url=document.getElementById('modal-product-url').value; if(document.getElementById('modal-product-img').value) p.img=document.getElementById('modal-product-img').value; else if(document.getElementById('modal-product-preview').src) p.img=document.getElementById('modal-product-preview').src; p.categoryId=parseInt(document.getElementById('modal-product-category').value)||null; p.available=document.getElementById('modal-product-available').value==='true'; p.showPrice=document.getElementById('modal-product-showPrice').checked; } 
            window.renderEditorProducts(); window.renderPreview(); window.closeProductModal(); 
        };
        window.handleProductFileSelect = (i) => { if(i.files[0]) { const r=new FileReader(); r.onload=e=>document.getElementById('modal-product-preview').src=e.target.result; r.readAsDataURL(i.files[0]); } };
        window.toggleProductVisibility = (id) => { const p=window.appState.products.find(x=>x.id===id); if(p) { p.visible=!p.visible; window.renderEditorProducts(); window.renderPreview(); } };

        window.openCategoryManager = () => { window.renderCategoryList(); document.getElementById('category-modal').classList.remove('hidden'); };
        window.closeCategoryManager = () => { document.getElementById('category-modal').classList.add('hidden'); window.editingCategoryId=null; };
        window.renderCategoryList = () => { const c=document.getElementById('category-list-container'); c.innerHTML=''; window.appState.categories.forEach(cat => { c.innerHTML += window.editingCategoryId===cat.id ? `<div class="bg-white p-3 rounded-xl border flex gap-2"><input id="edit-cat-${cat.id}" value="${cat.name}" class="apple-input flex-1 px-2 py-1 text-sm"><button onclick="saveCategoryEdit(${cat.id})" class="text-blue-500"><i class="ph-bold ph-check"></i></button></div>` : `<div class="bg-white p-3 rounded-xl border flex justify-between items-center"><span class="text-sm font-medium">${cat.name}</span><div class="flex gap-2"><button onclick="editingCategoryId=${cat.id};renderCategoryList()" class="text-gray-400 hover:text-blue-500"><i class="ph-bold ph-pencil-simple"></i></button><button onclick="openDeleteModal('category', ${cat.id})" class="text-gray-400 hover:text-red-500"><i class="ph-bold ph-trash"></i></button></div></div>`; }); };
        window.addCategory = () => { const n=document.getElementById('new-category-name').value.trim(); if(n) { window.appState.categories.push({id:Date.now(), name:n}); document.getElementById('new-category-name').value=''; window.renderCategoryList(); window.renderPreview(); } };
        window.saveCategoryEdit = (id) => { const n=document.getElementById(`edit-cat-${id}`).value.trim(); if(n) { window.appState.categories.find(c=>c.id===id).name=n; window.editingCategoryId=null; window.renderCategoryList(); window.renderPreview(); } };

        window.openDeleteModal = (type, id) => { window.pendingDeleteAction={type,id}; document.getElementById('delete-modal').classList.remove('hidden'); };
        window.closeDeleteModal = () => document.getElementById('delete-modal').classList.add('hidden');
        window.confirmDeleteAction = async () => {
            const {type, id} = window.pendingDeleteAction;
            if(type==='page') await deleteDoc(doc(db,'artifacts',appId,'users',window.currentUser.uid,'pages',id));
            else {
                if(type==='link') window.appState.links=window.appState.links.filter(x=>x.id!==id);
                if(type==='social') window.appState.socials=window.appState.socials.filter(x=>x.id!==id);
                if(type==='product') window.appState.products=window.appState.products.filter(x=>x.id!==id);
                if(type==='category') { window.appState.categories=window.appState.categories.filter(x=>x.id!==id); window.appState.products.forEach(p=>{if(p.categoryId===id)p.categoryId=null}); }
                window.renderEditorLinks(); window.renderEditorSocials(); window.renderEditorProducts(); window.renderCategoryList(); window.renderPreview();
            }
            window.closeDeleteModal();
        };

        window.renderSectionsEditor = () => { const c=document.getElementById('sections-container'); c.innerHTML=''; window.appState.sections.forEach(s=>{const icon=s.enabled?'ph-eye':'ph-eye-slash text-gray-300'; c.innerHTML+=`<div class="bg-white p-3 rounded-xl border flex items-center gap-2"><i class="ph-bold ph-dots-six-vertical text-gray-400 drag-handle"></i><span class="flex-1 text-sm font-medium ${s.enabled?'':'text-gray-400'}">${s.label}</span><button onclick="toggleSectionVisibility('${s.id}')" class="p-2"><i class="ph-bold ${icon} text-lg"></i></button></div>`;}); };
        window.toggleSectionVisibility = (id) => { const s=window.appState.sections.find(x=>x.id===id); if(s) { s.enabled=!s.enabled; window.renderSectionsEditor(); window.renderPreview(); } };

        window.setTheme = (t) => { window.appState.design.theme=t; window.renderPreview(); };
        window.setButtonStyle = (s) => { let t='rounded-xl'; if(s==='sharp') t='rounded-none'; if(s==='pill') t='rounded-full'; window.appState.design.buttonStyle=t; window.updateButtonStyleButtons(s); window.renderPreview(); };
        window.updateButtonStyleButtons = (s) => { document.getElementById('button-styles-container').innerHTML = `<button onclick="setButtonStyle('sharp')" class="h-12 border-2 ${s==='sharp'?'border-black bg-black text-white':'border-gray-200 hover:border-gray-900'} rounded-none text-sm font-medium">Cuadrado</button><button onclick="setButtonStyle('rounded')" class="h-12 border-2 ${s==='rounded'?'border-black bg-black text-white':'border-gray-200 hover:border-gray-900'} rounded-xl text-sm font-medium">Redondeado</button><button onclick="setButtonStyle('pill')" class="h-12 border-2 ${s==='pill'?'border-black bg-black text-white':'border-gray-200 hover:border-gray-900'} rounded-full text-sm font-medium">Píldora</button>`; };

        window.setPreviewView = (view) => {
            window.previewView = view;
            const scroll = document.getElementById('preview-scroll-container'); if(scroll) scroll.scrollTop=0;
            document.getElementById('view-home').classList.toggle('hidden', view !== 'home');
            document.getElementById('view-catalog').classList.toggle('hidden', view === 'home');
            document.getElementById('view-catalog').classList.toggle('flex', view !== 'home');
            window.renderPreview();
        };

        window.openFilterMenu = () => { 
            const m = document.getElementById('filter-menu'); const c = document.getElementById('filter-options-container'); c.innerHTML = `<button onclick="selectFilter('all')" class="w-full text-left px-4 py-3 rounded-xl flex justify-between font-medium ${window.categoryFilter==='all'?'bg-blue-50 text-blue-500':'hover:bg-gray-50'}"><span>Todo</span></button>`; window.appState.categories.forEach(cat => c.innerHTML += `<button onclick="selectFilter(${cat.id})" class="w-full text-left px-4 py-3 rounded-xl flex justify-between font-medium ${window.categoryFilter===cat.id?'bg-blue-50 text-blue-500':'hover:bg-gray-50'}"><span>${cat.name}</span></button>`); m.classList.remove('hidden'); setTimeout(()=>m.classList.add('open'),10); 
        };
        window.closeFilterMenu = () => { const m = document.getElementById('filter-menu'); m.classList.remove('open'); setTimeout(()=>m.classList.add('hidden'),300); };
        window.selectFilter = (id) => { window.categoryFilter = id; window.closeFilterMenu(); window.renderPreview(); };

        window.getIconForUrl = (url) => { if(!url) return 'ph-link'; const l=url.toLowerCase(); const f=ICON_MAP.find(i=>i.domains&&i.domains.some(d=>l.includes(d))); return f?f.id:'ph-link'; };
        window.copyCode = () => alert("HTML Copiado");

        window.renderPreview = () => {
             if(!window.appState) return;
             const theme = { snow:{bg:'bg-white',text:'text-gray-900', btnBg: 'bg-gray-100', btnText: 'text-gray-900'}, midnight:{bg:'bg-gray-900',text:'text-white', btnBg: 'bg-gray-800', btnText: 'text-white'}, blue:{bg:'bg-blue-600',text:'text-white', btnBg: 'bg-white/10', btnText: 'text-white'}, sand:{bg:'bg-orange-50',text:'text-gray-800', btnBg: 'bg-orange-100', btnText: 'text-gray-800'}, forest:{bg:'bg-green-800',text:'text-white', btnBg: 'bg-green-700', btnText: 'text-white'}, lavender:{bg:'bg-purple-100',text:'text-purple-900', btnBg: 'bg-white', btnText: 'text-purple-900'}, sunset:{bg:'bg-orange-400',text:'text-white', btnBg: 'bg-white/20', btnText: 'text-white'}, monochrome:{bg:'bg-gray-100',text:'text-black', btnBg: 'bg-white', btnText: 'text-black'} }[window.appState.design.theme] || {bg:'bg-white',text:'text-gray-900', btnBg: 'bg-gray-100', btnText: 'text-gray-900'};
             const bg = document.getElementById('preview-bg');
             bg.className = `min-h-full w-full pt-16 pb-8 px-6 flex flex-col items-center transition-all duration-500 ${theme.bg}`;
             
             if(window.previewView === 'home') {
                 const container = document.getElementById('preview-sections-container'); container.innerHTML = '';
                 window.appState.sections.forEach(sec => {
                     if(!sec.enabled) return;
                     if(sec.id === 'profile') container.innerHTML += `<div class="text-center mb-6 w-full"><img src="${window.appState.profile.avatar}" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover"><h2 class="text-xl font-bold ${theme.text}">${window.appState.profile.name}</h2><p class="text-sm opacity-80 ${theme.text}">${window.appState.profile.bio}</p></div>`;
                     if(sec.id === 'links') window.appState.links.forEach(l => container.innerHTML += `<a href="${l.url}" class="block w-full ${theme.btnBg} ${theme.btnText} p-3 mb-3 text-center text-sm font-medium ${window.appState.design.buttonStyle} flex items-center justify-center gap-2"><i class="ph-bold ${l.icon}"></i>${l.title}</a>`);
                     if(sec.id === 'socials') { let h='<div class="flex justify-center gap-4 mb-4">'; window.appState.socials.forEach(s=>h+=`<a href="${s.url}" class="text-2xl ${theme.text}"><i class="ph-bold ${s.icon}"></i></a>`); h+='</div>'; container.innerHTML+=h; }
                     if(sec.id === 'products') { 
                         const vis = window.appState.products.filter(p=>p.visible).slice(0,2);
                         vis.forEach(p => container.innerHTML += window.renderProductCard(p, theme));
                         if(window.appState.products.filter(p=>p.visible).length>2) container.innerHTML+=`<button onclick="setPreviewView('catalog')" class="w-full py-2 mt-2 border rounded-xl text-sm ${theme.text}">Ver Catálogo</button>`;
                     }
                 });
             } else {
                 const c = document.getElementById('preview-products-catalog'); c.innerHTML='';
                 const title = document.querySelector('#view-catalog h2'); if(title) title.className=`text-lg font-bold text-center ${theme.text}`;
                 const back = document.querySelector('#view-catalog button i'); if(back) back.className=`ph-bold ph-arrow-left text-xl ${theme.text}`;
                 
                 let filtered = window.appState.products.filter(p => p.visible);
                 if(window.categoryFilter !== 'all') filtered = filtered.filter(p => p.categoryId == window.categoryFilter);
                 filtered.forEach(p => c.innerHTML += window.renderProductCard(p, theme));
             }
        };

        window.renderProductCard = (p, t) => {
             const r = window.appState.design.buttonStyle === 'rounded-full' ? 'rounded-2xl' : window.appState.design.buttonStyle;
             const price = p.showPrice ? `<span class="text-xs font-semibold px-2 py-1 rounded-md bg-gray-100 text-gray-600">${p.price}</span>` : '';
             const badge = p.available ? `<span class="absolute top-2 right-2 bg-green-500 text-white text-[10px] px-2 py-0.5 rounded-full z-10">Disponible</span>` : '<span class="absolute top-2 right-2 bg-gray-500 text-white text-[10px] px-2 py-0.5 rounded-full z-10">Agotado</span>';
             const op = p.available ? '' : 'grayscale opacity-60';
             let catName = ''; if(p.categoryId) { const c = window.appState.categories.find(cat => cat.id === p.categoryId); if(c) catName = c.name; }
             
             return `<a href="${p.url}" class="block w-full bg-white ${r} overflow-hidden shadow-sm mb-3 relative ${op}">${badge}<div class="h-40 bg-gray-100"><img src="${p.img}" class="object-cover w-full h-full"></div><div class="p-3"><div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-900 truncate flex-1">${p.title}</span>${price}</div>${catName ? `<p class="text-[10px] uppercase tracking-wider font-semibold opacity-50 text-gray-900">${catName}</p>` : ''}</div></a>`;
        };

        window.publishPage = () => {
            window.saveCurrentPage();
            
            // Get the current page title/slug for the tab title
            const pageName = window.pages.find(p => p.id === window.currentPageId)?.name || 'Mi BioLink';
            
            // Generate clean HTML
            const theme = { snow: { bg: 'bg-white', text: 'text-gray-900', btnBg: 'bg-gray-100', btnText: 'text-gray-900', border: '' }, midnight: { bg: 'bg-[#121212]', text: 'text-white', btnBg: 'bg-[#1d1d1f]', btnText: 'text-white', border: 'border-gray-800' }, blue: { bg: 'bg-gradient-to-br from-blue-600 to-indigo-700', text: 'text-white', btnBg: 'bg-white/10', btnText: 'text-white', border: 'border-white/20' }, sand: { bg: 'bg-[#f3e9dc]', text: 'text-[#5e503f]', btnBg: 'bg-[#5e503f]', btnText: 'text-[#f3e9dc]', border: '' }, forest: { bg: 'bg-gradient-to-br from-emerald-800 to-teal-900', text: 'text-white', btnBg: 'bg-white/10', btnText: 'text-white', border: 'border-white/20' }, lavender: { bg: 'bg-[#F3E8FF]', text: 'text-[#4A1D96]', btnBg: 'bg-white', btnText: 'text-[#4A1D96]', border: 'border-[#E9D5FF]' }, sunset: { bg: 'bg-gradient-to-br from-orange-400 to-pink-500', text: 'text-white', btnBg: 'bg-white/20', btnText: 'text-white', border: 'border-white/30' }, monochrome: { bg: 'bg-gray-100', text: 'text-black', btnBg: 'bg-white', btnText: 'text-black', border: 'border-2 border-black' } }[window.appState.design.theme];
            
            let contentHTML = '';
            
            // Re-use rendering logic but for static HTML
            window.appState.sections.forEach(sec => {
                if(!sec.enabled) return;
                if (sec.id === 'profile') {
                    contentHTML += `<div class="flex flex-col items-center mb-6 text-center w-full max-w-md mx-auto animate-fade-in"><img src="${window.appState.profile.avatar}" class="w-24 h-24 rounded-full object-cover mb-4 shadow-lg ring-4 ring-white/20"><h2 class="text-xl font-bold ${theme.text}">${window.appState.profile.name}</h2><p class="text-sm opacity-80 ${theme.text}">${window.appState.profile.bio}</p></div>`;
                }
                if (sec.id === 'socials') {
                    let items = '';
                    window.appState.socials.forEach(s => { items += `<a href="${s.url}" target="_blank" class="text-3xl p-2 ${theme.text} opacity-80 hover:opacity-100 transition-opacity"><i class="ph-bold ${s.icon}"></i></a>`; });
                    if(items) contentHTML += `<div class="flex justify-center gap-4 w-full max-w-md mx-auto mb-6 flex-wrap">${items}</div>`;
                }
                if (sec.id === 'links') {
                    let items = '';
                    window.appState.links.forEach(l => { 
                         const b = theme.border || '';
                         items += `<a href="${l.url}" target="_blank" class="block w-full py-4 px-6 mb-3 font-medium text-sm flex items-center gap-3 transition-transform hover:scale-[1.02] active:scale-95 ${window.appState.design.buttonStyle} ${theme.btnBg} ${theme.btnText} ${b}"><i class="ph-bold ${l.icon} text-xl"></i><span class="truncate flex-1 text-center">${l.title}</span></a>`; 
                    });
                    if(items) contentHTML += `<div class="w-full max-w-md mx-auto mb-6">${items}</div>`;
                }
                if (sec.id === 'products') {
                    const visibleProducts = window.appState.products.filter(p => p.visible);
                    if (visibleProducts.length > 0) {
                        let items = '';
                        visibleProducts.forEach(p => {
                             // Use same card logic as preview but inline
                             const r = window.appState.design.buttonStyle === 'rounded-full' ? 'rounded-2xl' : window.appState.design.buttonStyle;
                             const price = p.showPrice ? `<span class="text-xs font-semibold px-2 py-1 rounded-md bg-gray-100 text-gray-600">${p.price}</span>` : '';
                             const badge = p.available ? `<span class="absolute top-3 right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-10">Disponible</span>` : `<span class="absolute top-3 right-3 bg-gray-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-10">Agotado</span>`;
                             const op = p.available ? '' : 'grayscale opacity-60 pointer-events-none';
                             const bgCard = window.appState.design.theme === 'midnight' ? 'bg-[#1d1d1f]' : 'bg-white';
                             const txt = theme.text === 'text-white' ? 'text-white' : 'text-gray-900';
                             let catName = ''; if(p.categoryId) { const c = window.appState.categories.find(cat => cat.id === p.categoryId); if(c) catName = c.name; }
                             
                             items += `<a href="${p.available ? p.url : '#'}" target="_blank" class="block w-full ${bgCard} ${r} overflow-hidden shadow-sm transition-transform ${op} relative mb-4 hover:scale-[1.01]"><div class="w-full h-56 bg-gray-100 relative overflow-hidden">${badge}<img src="${p.img}" class="object-cover w-full h-full"></div><div class="px-5 py-4"><div class="flex items-center justify-between mb-1"><h4 class="text-base font-bold truncate ${txt}">${p.title}</h4>${price}</div>${catName ? `<p class="text-[10px] uppercase tracking-wider font-semibold opacity-50 ${txt}">${catName}</p>` : ''}</div></a>`;
                        });
                        contentHTML += `<div class="w-full max-w-md mx-auto mb-6"><h3 class="text-center text-sm font-bold opacity-50 mb-4 ${theme.text}">TIENDA</h3>${items}</div>`;
                    }
                }
            });

            const finalHTML = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${pageName}</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <script src="https://unpkg.com/@phosphor-icons/web"><\/script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="${theme.bg} min-h-screen py-12 px-6 flex flex-col items-center">
    ${contentHTML}
    <div class="text-center mt-12 pb-6">
        <p class="text-[10px] uppercase tracking-widest font-bold opacity-30 ${theme.text}">Con tecnología de BioLink Studio</p>
    </div>
</body>
</html>`;

            const blob = new Blob([finalHTML], {type: 'text/html'});
            window.open(URL.createObjectURL(blob), '_blank');
        };

        function initSortable() {
            ['links-container', 'products-editor-container', 'sections-container'].forEach(id => {
                const el = document.getElementById(id);
                if(el) Sortable.create(el, { animation: 150, handle: '.drag-handle', onEnd: (evt) => {
                    if(id.includes('links')) window.appState.links.splice(evt.newIndex, 0, window.appState.links.splice(evt.oldIndex, 1)[0]);
                    if(id.includes('products')) window.appState.products.splice(evt.newIndex, 0, window.appState.products.splice(evt.oldIndex, 1)[0]);
                    if(id.includes('sections')) window.appState.sections.splice(evt.newIndex, 0, window.appState.sections.splice(evt.oldIndex, 1)[0]);
                    window.renderPreview();
                }});
            });
        }

    </script>
</body>
</html>
